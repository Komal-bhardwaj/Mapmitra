<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main Project Form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="photos/image.png">
</head>



<style>

body {
    background-color:rgb(227, 242, 251);
    font-family: 'Arial', sans-serif;
}

header {
    background-color: #343a40;
    color: white;
    padding: 20px;
}

h1, h2 {
    font-weight: bold;
}

.container {
    margin-top: 50px;
}

label {
    font-weight: 600;
}

footer {
    background-color: #343a40;
    color: white;
    padding: 20px;
    margin-top: 40px;
}


form {
    background-color: white;
    border: 1px solid #ddd;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

button {
    font-weight: 600;
}

button.btn-primary {
    background-color: #007bff;
    border-color: #007bff;
}

button.btn-secondary {
    background-color: #6c757d;
    border-color: #6c757d;
}

select.form-select {
    border-radius: 5px;
    padding: 8px;
    font-size: 1rem;
}


input:invalid, select:invalid {
    border-color: red;
}

input:valid, select:valid {
    border-color: #28a745;
}


.review-card, .request-card {
    background-color: white;
    border-radius: 8px;
    padding: 15px;
    border: 1px solid #e0e0e0;
    transition: transform 0.3s ease-in-out;
}

.review-card:hover, .request-card:hover {
    transform: scale(1.02);
}

.review-card h4, .request-card h4 {
    font-size: 1.2rem;
    margin-bottom: 10px;
}

.review-card p, .request-card p {
    font-size: 1rem;
}

.delete-btn {
    margin-top: 10px;
    background-color: #dc3545;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 5px;
    cursor: pointer;
}

.delete-btn:hover {
    background-color: #c82333;
}

@media (max-width: 768px) {
    .container {
        margin-top: 20px;
    }

    form {
        padding: 20px;
    }

    h1, h2 {
        font-size: 1.5rem;
    }
}
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.modal-content {
    background: white;
    padding: 20px;
    border-radius: 5px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
}

.modal-body {
    text-align: center;
}
</style>



<body>
    <header class="text-center bg-dark text-white py-3">
        <h1 class="display-4">SANKALP</h1>
        <p class="lead">Please fill out the form below to let us know what you need</p>
    </header>

    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-lg-6">
                <h2 class="mb-4 text-center">Submit Your Request</h2>
                <form id="requestForm">
                    <div class="mb-3">
                        <label for="name" class="form-label">Your Name</label>
                        <input type="text" class="form-control" id="name" placeholder="Enter your name" required>
                    </div>
                    <div class="mb-3">
                        <label for="location" class="form-label">Your Location</label>
                        <input type="text" class="form-control" id="location" placeholder="Enter your location" required>
                    </div>
                    <div class="mb-3">
                        <label for="requestType" class="form-label">What do you want to get?</label>
                        <select class="form-select" id="requestType" required>
                            <option value="">Select an option</option>
                            <option value="Food">Food</option>
                            <option value="Clothes">Clothes</option>
                            <option value="Books">Books</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="fileUpload" class="form-label">Choose a File</label>
                        <input type="file" class="form-control" id="fileUpload" required>
                    </div>
                    <div class="mb-3">
                        <label for="walletAddress" class="form-label">MetaMask Wallet Address</label>
                        <input type="text" class="form-control" id="walletAddress" placeholder="Enter your MetaMask Wallet Address" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit Request</button>
                </form>
                <button id="requestToggleBtn" class="btn btn-secondary mt-4" style="display: none;">Want to Make Another Request?</button>
            </div>

            <div class="col-lg-6" id="requestSection" style="display: none;">
                <h2 class="mb-4">Past Requests</h2>
                <div id="requestList">
                    <!-- Requests will be displayed here dynamically -->
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center text-white bg-dark py-4 mt-5">
        <p>&copy; 2024 Your Name. All Rights Reserved.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('requestForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        console.log("Form submitted");

        // Get form values
        const name = document.getElementById('name').value.trim();
        const location = document.getElementById('location').value.trim();
        const requestType = document.getElementById('requestType').value.trim();
        const walletAddress = document.getElementById('walletAddress').value.trim();
        const fileInput = document.getElementById('fileUpload');

        if (!fileInput.files.length) {
            console.error("No file selected");
            alert("Please select a file to upload.");
            return;
        }

        const file = fileInput.files[0];
        const formData = new FormData();

        // Append the file to FormData
        formData.append('file', file);

        // Pinata API endpoint for pinning files
        const pinFileUrl = `https://api.pinata.cloud/pinning/pinFileToIPFS`;

        let ipfsFileHash;
        try {
          
            const fileResponse = await fetch(pinFileUrl, {
                method: 'POST',
                headers: {
                    pinata_api_key: 'bfdca2a32574aa901b98',  // Replace with your Pinata API Key
                    pinata_secret_api_key: '85d4ad270d69bfb949784df759278e904abad0faaf8b7ba2cd337d8fb78af1e8' // Replace with your Pinata Secret Key
                },
                body: formData
            });

            if (!fileResponse.ok) {
                throw new Error(`Failed to upload file to Pinata: ${fileResponse.statusText}`);
            }

            const fileData = await fileResponse.json();
            ipfsFileHash = fileData.IpfsHash; 
            console.log("File uploaded to IPFS:", ipfsFileHash);

        } catch (error) {
            console.error("Error uploading file to Pinata:", error);
            alert("Error uploading file to Pinata. Please try again.");
            return;
        }

      
        const metadata = {
            name: name,
            location: location,
            requestType: requestType,
            walletAddress: walletAddress,
            fileIpfsHash: ipfsFileHash 
        };

        const pinJSONUrl = `https://api.pinata.cloud/pinning/pinJSONToIPFS`;

        let ipfsMetadataHash;
        try {
           
            const metadataResponse = await fetch(pinJSONUrl, {
                method: 'POST',
                headers: {
                    pinata_api_key: 'bfdca2a32574aa901b98',  
                    pinata_secret_api_key: '85d4ad270d69bfb949784df759278e904abad0faaf8b7ba2cd337d8fb78af1e8', 
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: `${name}'s Request Metadata`,
                    keyvalues: metadata
                })
            });

            if (!metadataResponse.ok) {
                throw new Error(`Failed to upload metadata to Pinata: ${metadataResponse.statusText}`);
            }

            const metadataData = await metadataResponse.json();
            ipfsMetadataHash = metadataData.IpfsHash;
            console.log("Metadata uploaded to IPFS:", ipfsMetadataHash);

          
            const requests = JSON.parse(localStorage.getItem('requests')) || [];
            requests.push({
                ipfsFileHash,
                ipfsMetadataHash,
                name: name,
                location: location,
                requestType: requestType,
                walletAddress: walletAddress
            });
            localStorage.setItem('requests', JSON.stringify(requests));

         
            document.getElementById('requestForm').reset();

       
            showSuccessModal(ipfsMetadataHash);

        } catch (error) {
            console.error("Error uploading metadata to Pinata:", error);
            alert("Error uploading form metadata to Pinata. Please try again.");
        }
    });

  
    function showSuccessModal(ipfsHash) {
      
        const modalContent = `
            <div class="modal-overlay">
                <div class="modal-content">
                    <div class="modal-body">
                        <div class="text-center">
                            <svg width="100" height="100" viewBox="0 0 16 16" class="bi bi-check-circle-fill text-success mb-3" xmlns="http://www.w3.org/2000/svg" fill="green">
                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM6.857 11.243 4.105 8.49a.563.563 0 1 0-.796.796l3 3a.563.563 0 0 0 .796 0l6-6a.563.563 0 1 0-.796-.796L6.857 11.243z"/>
                            </svg>
                            <h3 class="mb-3">Form Submitted Successfully!</h3>
                            <p><strong>IPFS Metadata Hash:</strong> ${ipfsHash}</p>
                            <button id="goToMapMitraBtn" class="btn btn-primary mt-3">Go to MapMitra</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

     
        document.body.insertAdjacentHTML('beforeend', modalContent);

       
        document.getElementById('goToMapMitraBtn').addEventListener('click', function () {
            window.location.href = 'index2.html';
        });
    }

  
    async function displayRequests() {
        const requests = JSON.parse(localStorage.getItem('requests')) || [];
        
        const requestList = document.getElementById('requestList');
        requestList.innerHTML = ''; 

        for (const request of requests) {
            let content = '';

          
            try {
                if (request.ipfsFileHash) {
                    const fileResponse = await fetch(`https://gateway.pinata.cloud/ipfs/${request.ipfsFileHash}`);
                    
                  
                    const contentType = fileResponse.headers.get("content-type");

                    if (contentType.startsWith("image/")) {
                      
                        content = `<img src="https://gateway.pinata.cloud/ipfs/${request.ipfsFileHash}" alt="${request.name}'s file" class="img-fluid mb-3" />`;
                    }

               
                    if (request.ipfsMetadataHash) {
                        const metadataResponse = await fetch(`https://gateway.pinata.cloud/ipfs/${request.ipfsMetadataHash}`);
                        const metadata = await metadataResponse.json();
                        content += `
                            <p><strong>Name:</strong> ${metadata.name}</p>
                            <p><strong>Location:</strong> ${metadata.location}</p>
                            <p><strong>Request Type:</strong> ${metadata.requestType}</p>
                            <p><strong>Wallet Address:</strong> ${metadata.walletAddress}</p>
                        `;
                    }

                    
                    const requestCard = document.createElement('div');
                    requestCard.classList.add('request-card', 'mb-3', 'shadow-sm');
                    requestCard.innerHTML = `
                        <h4>${request.name} from ${request.location} wants ${request.requestType}</h4>
                        <p><strong>Wallet Address: ${request.walletAddress}</strong></p>
                        <p><strong>IPFS Hash:</strong> ${request.ipfsFileHash}</p>
                        ${content} <!-- Display content (image or text) -->
                        <button class="delete-btn btn btn-danger" data-index="${requests.indexOf(request)}">Delete</button>
                    `;
                    requestList.appendChild(requestCard);
                }
            } catch (error) {
                console.error("Error fetching from IPFS:", error);
            }
        }

     
        const deleteButtons = document.querySelectorAll('.delete-btn');
        deleteButtons.forEach(button => {
            button.addEventListener('click', function () {
                const index = this.getAttribute('data-index');
                deleteRequest(index);
            });
        });
    }


    function deleteRequest(index) {
        const requests = JSON.parse(localStorage.getItem('requests')) || [];
        requests.splice(index, 1); 
        localStorage.setItem('requests', JSON.stringify(requests)); 
        displayRequests(); 
    }

    displayRequests();
});

    </script>
</body>
</html>
